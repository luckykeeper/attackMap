(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{594:function(s,t,a){"use strict";a.r(t);var n=a(11),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[s._v("本节将介绍使用源码部署的方法，此使用方法部署的本套系统已经在生产环境跑了一段时间，非常稳定，目前推荐在生产环境使用此方法部署")])]),a("h1",{attrs:{id:"环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[s._v("#")]),s._v(" 环境准备")]),s._v(" "),a("p",[s._v("我们推荐使用 Linux 来部署本套系统，在系统的选择上，推荐 Fedora 35 x64 ，主要是因为 Fedora 装的 Python 版本比较新，按照 docker 也非常方便，而且我也比较熟悉。")]),s._v(" "),a("p",[s._v("我们推荐的配置如下表，性能需求取决于数据量，每天 11 万条原始数据量的情况下推荐如下，请根据实际情况调整，另外，该方案假设你把所有服务（本项目的前后端）全部放在一台机器上跑")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("系统")]),s._v(" "),a("th",[s._v("Fedora 35 x64")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("CPU")]),s._v(" "),a("td",[s._v("推荐 8 核，最低 4 核")])]),s._v(" "),a("tr",[a("td",[s._v("RAM")]),s._v(" "),a("td",[s._v("4G")])]),s._v(" "),a("tr",[a("td",[s._v("HDD")]),s._v(" "),a("td",[s._v("145G（存储一年）")])])])]),s._v(" "),a("h1",{attrs:{id:"准备数据库和-nginx-服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备数据库和-nginx-服务器"}},[s._v("#")]),s._v(" 准备数据库和 Nginx 服务器")]),s._v(" "),a("p",[s._v("推荐使用 Docker 部署")]),s._v(" "),a("h2",{attrs:{id:"mongodb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongodb"}},[s._v("#")]),s._v(" MongoDB")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v(":27017 --restart"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always --name mongodb mongo:4.1.6 --auth\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("设置 root 账户密码（把下面的 "),a("code",[s._v("123")]),s._v(" 改成你要设置的密码）")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it mongodb mongo\nuse admin\nshow dbs\ndb.createUser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("user: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),s._v(", pwd: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123'")]),s._v(", roles: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("role: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root"')]),s._v(", db: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx"}},[s._v("#")]),s._v(" Nginx")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":80 --restart"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always --name nginx -v  /usr/local/nginx:/usr/share/nginx/html nginx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h1",{attrs:{id:"下载源码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载源码"}},[s._v("#")]),s._v(" 下载源码")]),s._v(" "),a("p",[s._v("检查你的 Python 版本，需要 >=3.5")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("python3 -V\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("首先，使用 Git 等方式将后端源码下载下来，我们以 "),a("code",[s._v("/home/pysyslog")]),s._v(" 为例")]),s._v(" "),a("p",[s._v("然后，使用 "),a("code",[s._v("vi")]),s._v(" 、 "),a("code",[s._v("vim")]),s._v("  等修改配置区域的变量")]),s._v(" "),a("p",[s._v("虽然源码这里已经写的非常详细了，不过在这里也提一下，我们以 "),a("code",[s._v("calcAttack.py")]),s._v(" 为例来讲解一下")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("################################ 基础设定 ################################")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 调试模式 True = ON; False = OFF")]),s._v("\ndebug "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## MongoDB 数据库设定")]),s._v("\nMongoDB_host "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 数据库IP 形如："127.0.0.1"')]),s._v("\nMongoDB_port "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 数据库端口 形如："int(12345)"')]),s._v("\nMongoDB_user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 数据库用户 形如："user"，请使用 root 账户，否则可能产生意外的问题')]),s._v("\nMongoDB_password "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 数据库密码 形如："password"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### 要读写的数据库名称和 collection")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读出")]),s._v("\nMongoDB_From_dbName "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"orgData"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 数据库名称 默认："orgData"')]),s._v("\nMongoDB_From_col "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"syslog"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# collection 名称 默认："syslog"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 写入")]),s._v("\nMongoDB_to_dbName "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"show"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 数据库名称 默认："show"')]),s._v("\nMongoDB_to_col "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bigScreen"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# collection 名称 默认："bigScreen"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 输出文件")]),s._v("\noutputCsvName "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'攻击IP.csv'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认：'攻击IP.csv'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## mmdb 文件位置，可写相对位置，如使用 Cron 定时运行请写绝对位置")]),s._v("\nmmdbLocation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/pysyslog/GeoLite2-City.mmdb'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[s._v("如上所示，后端每个文件都在最开始提供了配置区域，如果需要修改配置，修改这里的内容就 OK 啦")]),s._v(" "),a("p",[s._v("几点注意事项：")]),s._v(" "),a("ol",[a("li",[s._v("测试的时候推荐打开调试模式看是否能收到数据")]),s._v(" "),a("li",[a("code",[s._v("MongoDB_host")]),s._v(" 这里请 "),a("code",[s._v("一定")]),s._v(" 填写机器的 IP 地址而不是 "),a("code",[s._v("127.0.0.1")]),s._v(" ，否则可能会导致奇奇怪怪的问题发生")]),s._v(" "),a("li",[s._v("mmdb 文件位置最好写绝对位置")]),s._v(" "),a("li",[s._v("可以用 "),a("code",[s._v("docker logs -f monogdb")]),s._v(" 看数据是否写入")])]),s._v(" "),a("h1",{attrs:{id:"配置定时任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置定时任务"}},[s._v("#")]),s._v(" 配置定时任务")]),s._v(" "),a("p",[s._v("后端组件中各组件应当按照如下规则运行（可视实际情况调整）")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("组件名称")]),s._v(" "),a("th",[s._v("定时运行要求")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("sysloger.py")]),s._v(" "),a("td",[s._v("开机运行")])]),s._v(" "),a("tr",[a("td",[s._v("apiv1.py")]),s._v(" "),a("td",[s._v("开机运行")])]),s._v(" "),a("tr",[a("td",[s._v("calcAttack.py")]),s._v(" "),a("td",[s._v("每5分钟运行一次")])]),s._v(" "),a("tr",[a("td",[s._v("backupOrgData.py")]),s._v(" "),a("td",[s._v("每天定时运行一次且在 mailAlert.py 组件运行后")])]),s._v(" "),a("tr",[a("td",[s._v("mailAlert.py")]),s._v(" "),a("td",[s._v("每天定时运行一次且在 backupOrgData.py 组件运行前")])]),s._v(" "),a("tr",[a("td",[s._v("deleteOldData.py")]),s._v(" "),a("td",[s._v("每天运行一次")])])])]),s._v(" "),a("p",[s._v("定时运行功能使用 "),a("code",[s._v("crontab")]),s._v(" 实现，在 Fedora 下，这个包需要安装，而在 Ubuntu 和 CentOS 下，这个包通常不需要安装")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Fedora 安装 crontab")]),s._v("\ndnf "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y cronie \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("安装后请使用 "),a("code",[s._v("systemctl")]),s._v(" 设置 "),a("code",[s._v("crontab")]),s._v(" 开机启动")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" crond "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl start crond\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("定时任务设置，如果看不懂请学习 "),a("code",[s._v("cron")]),s._v(" 规则")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("crontab")]),s._v(" -e\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 粘贴以下内容并用 :wq 保存")]),s._v("\n@reboot "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" python3 /home/pysyslog/sysloger.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n@reboot "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" python3 /home/pysyslog/apiv1.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n*/5 * * * * "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" python3 /home/pysyslog/calcAttack.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" * * * "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" python3 /home/pysyslog/backupOrgData.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n* "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" * * * "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" python3 /home/pysyslog/deleteOldData.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" * * * "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" python3 /home/pysyslog/mailAlert.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("之后，重启并验证是否配置完成")]),s._v(" "),a("p",[s._v("到此，恭喜你已经成功部署本套系统！")])])}),[],!1,null,null,null);t.default=e.exports}}]);